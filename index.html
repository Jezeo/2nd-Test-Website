<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schola De San Jose Portal Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            min-width: 250px;
            text-align: center;
        }
        .message-box.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .message-box.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message-box.info {
            background-color: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-gray-100">

    <!-- Main Container -->
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-4xl border border-gray-200">
        <!-- School Logo -->
        <img src="School_Logo.png" alt="School Logo" class="mx-auto mb-4 w-24 h-24 rounded-full shadow-md">

        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Schola De San Jose</h1>

        <!-- Message Box for notifications -->
        <div id="messageBox" class="message-box hidden"></div>

        <!-- Authentication Section (Login/Register) -->
        <div id="authSection" class="flex flex-col items-center justify-center gap-4">
            <!-- Login Form -->
            <div id="loginForm" class="w-full max-w-sm p-6 bg-white rounded-xl shadow-md border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Login</h2>
                <div class="mb-4">
                    <label for="loginUsername" class="block text-gray-700 text-sm font-medium mb-1">Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>
                <div class="mb-6">
                    <label for="loginPassword" class="block text-gray-700 text-sm font-medium mb-1">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                </div>
                <button onclick="loginUser()"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 text-lg font-semibold">
                    Login
                </button>
                <p class="mt-4 text-center text-gray-600">
                    Don't have an account? <a href="#" onclick="showRegistrationForm()" class="text-blue-600 hover:underline">Register here</a>
                </p>
            </div>

            <!-- Registration Form (Hidden by default) -->
            <div id="registerForm" class="hidden w-full max-w-sm p-6 bg-white rounded-xl shadow-md border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Register</h2>
                <div class="mb-4">
                    <label for="regUsername" class="block text-gray-700 text-sm font-medium mb-1">Username</label>
                    <input type="text" id="regUsername" placeholder="Choose a username"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200">
                </div>
                <div class="mb-4">
                    <label for="regPassword" class="block text-gray-700 text-sm font-medium mb-1">Password</label>
                    <input type="password" id="regPassword" placeholder="Choose a password"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200">
                </div>
                 <div class="mb-4">
                    <label for="regName" class="block text-gray-700 text-sm font-medium mb-1">Full Name</label>
                    <input type="text" id="regName" placeholder="e.g., Jane Smith"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200">
                </div>
                <div class="mb-4">
                    <label for="regId" class="block text-gray-700 text-sm font-medium mb-1">Student/Teacher ID</label>
                    <input type="text" id="regId" placeholder="e.g., S001 or T001"
                           class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200">
                </div>
                <div class="mb-6">
                    <label for="regRole" class="block text-gray-700 text-sm font-medium mb-1">Register As</label>
                    <select id="regRole"
                            class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200">
                        <option value="student">Student</option>
                        <option value="teacher">Teacher</option>
                    </select>
                </div>
                <button onclick="registerUser()"
                        class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200 text-lg font-semibold">
                    Register
                </button>
                <p class="mt-4 text-center text-gray-600">
                    Already have an account? <a href="#" onclick="showLoginForm()" class="text-blue-600 hover:underline">Login here</a>
                </p>
            </div>
        </div>

        <!-- Dashboard Section (Hidden by default) -->
        <div id="dashboardSection" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 id="dashboardTitle" class="text-2xl font-bold text-gray-800">Welcome, User!</h2>
                <button onclick="logoutUser()"
                        class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-200 text-sm">
                    Logout
                </button>
            </div>

            <!-- Dashboard Tabs -->
            <div class="flex border-b border-gray-200 mb-6">
                <button id="gradesTabBtn" onclick="showDashboardTab('grades')"
                        class="py-2 px-4 text-center text-lg font-medium text-gray-600 hover:text-blue-600 focus:outline-none border-b-2 border-transparent hover:border-blue-500 active:border-blue-600 transition duration-200">
                    Grades
                </button>
                <button id="attendanceTabBtn" onclick="showDashboardTab('attendance')"
                        class="py-2 px-4 text-center text-lg font-medium text-gray-600 hover:text-blue-600 focus:outline-none border-b-2 border-transparent hover:border-blue-500 active:border-blue-600 transition duration-200">
                    Attendance
                </button>
            </div>

            <!-- Grades Tab Content -->
            <div id="gradesTabContent" class="tab-content active">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Grades Overview</h3>

                <!-- Teacher-only: Input Grades -->
                <div id="teacherGradesInput" class="mb-6 p-4 bg-blue-50 rounded-lg shadow-sm border border-blue-200 hidden">
                    <h4 class="text-lg font-semibold text-blue-700 mb-3">Input Student Grade</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="gradeStudentId" class="block text-gray-700 text-sm font-medium mb-1">Student ID</label>
                            <input type="text" id="gradeStudentId" placeholder="e.g., S001"
                                   class="w-full p-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                        <div>
                            <label for="subject" class="block text-gray-700 text-sm font-medium mb-1">Subject</label>
                            <input type="text" id="subject" placeholder="e.g., Math"
                                   class="w-full p-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                        <div>
                            <label for="grade" class="block text-gray-700 text-sm font-medium mb-1">Grade (0-100)</label>
                            <input type="number" id="grade" min="0" max="100" placeholder="e.g., 85"
                                   class="w-full p-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                    </div>
                    <button onclick="submitGrade()"
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 text-md font-semibold">
                        Submit Grade
                    </button>
                </div>

                <!-- Teacher-only: All Grades Table -->
                <div id="allGradesDisplay" class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-700 mb-3">All Grades (Teacher View)</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left rounded-tl-lg">Student ID</th>
                                    <th class="py-3 px-6 text-left">Student Name</th>
                                    <th class="py-3 px-6 text-left">Subject</th>
                                    <th class="py-3 px-6 text-left">Grade</th>
                                    <th class="py-3 px-6 text-center rounded-tr-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="allGradesTableBody" class="text-gray-600 text-sm font-light">
                                <!-- All grades will be loaded here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center mt-4">
                        <button onclick="clearAllGrades()"
                                class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200 text-sm font-semibold">
                            Clear All Grades
                        </button>
                    </div>
                </div>

                <!-- Student-only: My Grades Table -->
                <div id="myGradesDisplay" class="p-4 bg-white rounded-lg shadow-sm border border-gray-200 hidden">
                    <h4 class="text-lg font-semibold text-gray-700 mb-3">My Grades</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left rounded-tl-lg">Subject</th>
                                    <th class="py-3 px-6 text-left">Grade</th>
                                    <th class="py-3 px-6 text-left rounded-tr-lg">Remarks</th>
                                </tr>
                            </thead>
                            <tbody id="studentGradesTableBody" class="text-gray-600 text-sm font-light">
                                <!-- Student's grades will be loaded here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Attendance Tab Content -->
            <div id="attendanceTabContent" class="tab-content">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Attendance Overview</h3>

                <!-- Teacher-only: Mark Attendance -->
                <div id="teacherAttendanceInput" class="mb-6 p-4 bg-blue-50 rounded-lg shadow-sm border border-blue-200 hidden">
                    <h4 class="text-lg font-semibold text-blue-700 mb-3">Mark Student Attendance</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="attendanceStudentId" class="block text-gray-700 text-sm font-medium mb-1">Student ID</label>
                            <input type="text" id="attendanceStudentId" placeholder="e.g., S001"
                                   class="w-full p-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                        <div>
                            <label for="attendanceDate" class="block text-gray-700 text-sm font-medium mb-1">Date</label>
                            <input type="date" id="attendanceDate"
                                   class="w-full p-2 border border-blue-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Status</label>
                            <div class="flex items-center space-x-4 h-full">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="attendanceStatus" value="Present" class="form-radio text-green-600 focus:ring-green-500" checked>
                                    <span class="ml-2 text-gray-700">Present</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="attendanceStatus" value="Absent" class="form-radio text-red-600 focus:ring-red-500">
                                    <span class="ml-2 text-gray-700">Absent</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="attendanceStatus" value="Late" class="form-radio text-yellow-600 focus:ring-yellow-500">
                                    <span class="ml-2 text-gray-700">Late</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <button onclick="markAttendance()"
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 text-md font-semibold">
                        Mark Attendance
                    </button>
                </div>

                <!-- Teacher-only: All Attendance Table -->
                <div id="allAttendanceDisplay" class="p-4 bg-white rounded-lg shadow-sm border border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-700 mb-3">All Attendance (Teacher View)</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left rounded-tl-lg">Student ID</th>
                                    <th class="py-3 px-6 text-left">Student Name</th>
                                    <th class="py-3 px-6 text-left">Date</th>
                                    <th class="py-3 px-6 text-left">Status</th>
                                    <th class="py-3 px-6 text-center rounded-tr-lg">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="allAttendanceTableBody" class="text-gray-600 text-sm font-light">
                                <!-- All attendance records will be loaded here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center mt-4">
                        <button onclick="clearAllAttendance()"
                                class="bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200 text-sm font-semibold">
                            Clear All Attendance Records
                        </button>
                    </div>
                </div>

                <!-- Student-only: My Attendance Table -->
                <div id="myAttendanceDisplay" class="p-4 bg-white rounded-lg shadow-sm border border-gray-200 hidden">
                    <h4 class="text-lg font-semibold text-gray-700 mb-3">My Attendance</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead>
                                <tr class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left rounded-tl-lg">Date</th>
                                    <th class="py-3 px-6 text-left rounded-tr-lg">Status</th>
                                </tr>
                            </thead>
                            <tbody id="studentAttendanceTableBody" class="text-gray-600 text-sm font-light">
                                <!-- Student's attendance records will be loaded here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Clear All Users Button (for admin/testing) -->
            <div class="mt-8 text-center">
                 <button onclick="clearAllUsers()"
                    class="bg-gray-400 text-white py-2 px-4 rounded-lg hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-200 text-sm font-semibold">
                    Clear All Users (Admin/Testing)
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Local Storage Keys ---
        const USERS_STORAGE_KEY = 'schoolPortalUsers';
        const STUDENTS_DATA_KEY = 'schoolPortalStudentsData'; // Stores student names and IDs
        const GRADES_STORAGE_KEY = 'schoolPortalGrades';
        const ATTENDANCE_STORAGE_KEY = 'schoolPortalAttendance';

        // --- DOM Elements ---
        const messageBox = document.getElementById('messageBox');
        const authSection = document.getElementById('authSection');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const dashboardSection = document.getElementById('dashboardSection');
        const dashboardTitle = document.getElementById('dashboardTitle');

        // Login elements
        const loginUsernameInput = document.getElementById('loginUsername');
        const loginPasswordInput = document.getElementById('loginPassword');

        // Registration elements
        const regUsernameInput = document.getElementById('regUsername');
        const regPasswordInput = document.getElementById('regPassword');
        const regNameInput = document.getElementById('regName');
        const regIdInput = document.getElementById('regId');
        const regRoleSelect = document.getElementById('regRole');

        // Dashboard Tabs
        const gradesTabBtn = document.getElementById('gradesTabBtn');
        const attendanceTabBtn = document.getElementById('attendanceTabBtn');
        const gradesTabContent = document.getElementById('gradesTabContent');
        const attendanceTabContent = document.getElementById('attendanceTabContent');

        // Grades Tab elements
        const teacherGradesInput = document.getElementById('teacherGradesInput');
        const gradeStudentIdInput = document.getElementById('gradeStudentId');
        const subjectInput = document.getElementById('subject');
        const gradeInput = document.getElementById('grade');
        const allGradesDisplay = document.getElementById('allGradesDisplay');
        const allGradesTableBody = document.getElementById('allGradesTableBody');
        const myGradesDisplay = document.getElementById('myGradesDisplay');
        const studentGradesTableBody = document.getElementById('studentGradesTableBody');

        // Attendance Tab elements
        const teacherAttendanceInput = document.getElementById('teacherAttendanceInput');
        const attendanceStudentIdInput = document.getElementById('attendanceStudentId');
        const attendanceDateInput = document.getElementById('attendanceDate');
        const allAttendanceDisplay = document.getElementById('allAttendanceDisplay');
        const allAttendanceTableBody = document.getElementById('allAttendanceTableBody');
        const myAttendanceDisplay = document.getElementById('myAttendanceDisplay');
        const studentAttendanceTableBody = document.getElementById('studentAttendanceTableBody');

        let currentUser = null; // Stores the currently logged-in user

        // --- Initial Setup on Page Load ---
        window.onload = () => {
            // Set default date for attendance input
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            attendanceDateInput.value = `${year}-${month}-${day}`;

            // Check if user is already logged in (e.g., from a previous session)
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                showDashboard();
            } else {
                showLoginForm();
            }
        };

        // --- Utility Functions ---
        /**
         * Displays a notification message at the top of the screen.
         * @param {string} message - The message to display.
         * @param {string} type - The type of message ('success', 'error', 'info').
         */
        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = `message-box show ${type}`;
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                messageBox.classList.remove('show');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300);
            }, 3000);
        }

        /**
         * Shows a confirmation prompt using window.prompt for critical actions.
         * @param {string} message - The message to show in the prompt.
         * @param {string} expectedConfirmation - The exact string the user must type to confirm.
         * @returns {Promise<boolean>} Resolves to true if confirmed, false otherwise.
         */
        function confirmAction(message, expectedConfirmation) {
            return new Promise((resolve) => {
                showMessage(message, 'info');
                setTimeout(() => {
                    const confirmation = window.prompt(`Type '${expectedConfirmation}' to confirm:`, "");
                    resolve(confirmation === expectedConfirmation);
                }, 100);
            });
        }

        // --- User Authentication & Session Management ---
        /**
         * Retrieves all registered users from local storage.
         * @returns {Array<Object>} An array of user objects.
         */
        function getUsers() {
            const usersJson = localStorage.getItem(USERS_STORAGE_KEY);
            return usersJson ? JSON.parse(usersJson) : [];
        }

        /**
         * Saves user data to local storage.
         * @param {Array<Object>} users - The array of user objects to save.
         */
        function saveUsers(users) {
            localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users));
        }

        /**
         * Handles user registration.
         */
        async function registerUser() {
            const username = regUsernameInput.value.trim();
            const password = regPasswordInput.value.trim();
            const name = regNameInput.value.trim();
            const id = regIdInput.value.trim().toUpperCase();
            const role = regRoleSelect.value;

            if (!username || !password || !name || !id) {
                showMessage('Please fill in all registration fields.', 'error');
                return;
            }
            if (id.length < 3 || id.length > 10) {
                showMessage('ID must be between 3 and 10 characters.', 'error');
                return;
            }

            let users = getUsers();
            if (users.some(u => u.username === username)) {
                showMessage('Username already exists. Please choose another.', 'error');
                return;
            }
            if (users.some(u => u.id === id)) {
                showMessage('Student/Teacher ID already exists. Please use a unique ID.', 'error');
                return;
            }

            // For simplicity, passwords are stored in plain text.
            // In a real application, ALWAYS hash passwords (e.g., using bcrypt).
            users.push({ username, password, name, id, role });
            saveUsers(users);
            showMessage('Registration successful! You can now login.', 'success');
            regUsernameInput.value = '';
            regPasswordInput.value = '';
            regNameInput.value = '';
            regIdInput.value = '';
            regRoleSelect.value = 'student'; // Reset dropdown
            showLoginForm(); // Redirect to login form
        }

        /**
         * Handles user login.
         */
        async function loginUser() {
            const username = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value.trim();

            if (!username || !password) {
                showMessage('Please enter both username and password.', 'error');
                return;
            }

            const users = getUsers();
            const foundUser = users.find(u => u.username === username && u.password === password); // Plain text check

            if (foundUser) {
                currentUser = foundUser;
                localStorage.setItem('currentUser', JSON.stringify(currentUser)); // Store session
                showMessage(`Welcome, ${currentUser.name}! You are logged in as a ${currentUser.role}.`, 'success');
                loginUsernameInput.value = '';
                loginPasswordInput.value = '';
                showDashboard();
            } else {
                showMessage('Invalid username or password.', 'error');
            }
        }

        /**
         * Logs out the current user.
         */
        function logoutUser() {
            localStorage.removeItem('currentUser'); // Clear session
            currentUser = null;
            showMessage('You have been logged out.', 'info');
            showLoginForm();
        }

        /**
         * Clears all user accounts (admin/testing functionality).
         */
        async function clearAllUsers() {
            const confirmed = await confirmAction('This will delete ALL registered user accounts. Are you sure?', 'CLEAR');
            if (confirmed) {
                localStorage.removeItem(USERS_STORAGE_KEY);
                localStorage.removeItem(STUDENTS_DATA_KEY); // Clear associated student data
                localStorage.removeItem(GRADES_STORAGE_KEY); // Clear associated grades
                localStorage.removeItem(ATTENDANCE_STORAGE_KEY); // Clear associated attendance
                showMessage('All user accounts and associated data cleared.', 'success');
                logoutUser(); // Force logout
            }
        }

        // --- UI Visibility Functions ---
        function showLoginForm() {
            authSection.classList.remove('hidden');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            dashboardSection.classList.add('hidden');
        }

        function showRegistrationForm() {
            authSection.classList.remove('hidden');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            dashboardSection.classList.add('hidden');
        }

        function showDashboard() {
            authSection.classList.add('hidden');
            dashboardSection.classList.remove('hidden');
            dashboardTitle.textContent = `Welcome, ${currentUser.name}!`;

            // Adjust dashboard content based on user role
            if (currentUser.role === 'teacher') {
                teacherGradesInput.classList.remove('hidden');
                allGradesDisplay.classList.remove('hidden');
                myGradesDisplay.classList.add('hidden'); // Hide student view
                teacherAttendanceInput.classList.remove('hidden');
                allAttendanceDisplay.classList.remove('hidden');
                myAttendanceDisplay.classList.add('hidden'); // Hide student view
            } else { // Student
                teacherGradesInput.classList.add('hidden');
                allGradesDisplay.classList.add('hidden');
                myGradesDisplay.classList.remove('hidden'); // Show student view
                teacherAttendanceInput.classList.add('hidden');
                allAttendanceDisplay.classList.add('hidden');
                myAttendanceDisplay.classList.remove('hidden'); // Show student view
            }

            // Ensure grades tab is active by default on dashboard entry
            showDashboardTab('grades');
        }

        function showDashboardTab(tabName) {
            // Deactivate all tabs and contents
            gradesTabBtn.classList.remove('border-blue-600', 'text-blue-600');
            attendanceTabBtn.classList.remove('border-blue-600', 'text-blue-600');
            gradesTabContent.classList.remove('active');
            attendanceTabContent.classList.remove('active');

            // Activate selected tab and content
            if (tabName === 'grades') {
                gradesTabBtn.classList.add('border-blue-600', 'text-blue-600');
                gradesTabContent.classList.add('active');
                if (currentUser.role === 'teacher') {
                    displayAllGrades();
                } else {
                    displayMyGrades(currentUser.id);
                }
            } else if (tabName === 'attendance') {
                attendanceTabBtn.classList.add('border-blue-600', 'text-blue-600');
                attendanceTabContent.classList.add('active');
                if (currentUser.role === 'teacher') {
                    displayAllAttendance();
                } else {
                    displayMyAttendance(currentUser.id);
                }
            }
        }

        // --- Student Data (Name lookup for grades/attendance) ---
        /**
         * Retrieves student name data (separate from user accounts).
         * @returns {Array<Object>} An array of student objects ({ id, name }).
         */
        function getStudentsData() {
            const studentsJson = localStorage.getItem(STUDENTS_DATA_KEY);
            return studentsJson ? JSON.parse(studentsJson) : [];
        }

        /**
         * Saves student name data.
         * @param {Array<Object>} students - The array of student objects to save.
         */
        function saveStudentsData(students) {
            localStorage.setItem(STUDENTS_DATA_KEY, JSON.stringify(students));
        }

        /**
         * Registers a student (name and ID) for grade/attendance tracking.
         * This is a teacher-only function.
         */
        async function registerStudentForTracking() {
            // We'll reuse the regIdInput and regNameInput for this if the user is a teacher registering students.
            // Or, we can add dedicated inputs in the teacher dashboard if it's more appropriate.
            // For now, let's assume teacher adds students via their own account registration,
            // or we need a separate "Manage Students" section.

            // Since the current registration form registers accounts (users),
            // and those users can be students, we'll primarily use the 'id' and 'name'
            // from the registered user for grades/attendance.
            // If a teacher needs to add *unregistered* students (for attendance/grades only),
            // we'd need a dedicated form for that.
            // For this version, assume students who get grades/attendance logged
            // are also registered users.
            showMessage('Student profiles are created via the "Register" section, or if you are logged in as a teacher, you can manage specific student IDs within the grade/attendance sections.', 'info');
        }


        // --- Grades Management ---
        /**
         * Retrieves grade records.
         * @returns {Array<Object>} An array of grade objects ({ studentId, subject, grade }).
         */
        function getGradesRecords() {
            const recordsJson = localStorage.getItem(GRADES_STORAGE_KEY);
            return recordsJson ? JSON.parse(recordsJson) : [];
        }

        /**
         * Saves grade records.
         * @param {Array<Object>} records - The array of grade objects to save.
         */
        function saveGradesRecords(records) {
            localStorage.setItem(GRADES_STORAGE_KEY, JSON.stringify(records));
        }

        /**
         * Submits or updates a student's grade (Teacher function).
         */
        async function submitGrade() {
            const studentId = gradeStudentIdInput.value.trim().toUpperCase();
            const subject = subjectInput.value.trim();
            const grade = parseInt(gradeInput.value);

            if (!studentId || !subject || isNaN(grade)) {
                showMessage('Please fill in Student ID, Subject, and a valid Grade.', 'error');
                return;
            }
            if (studentId.length < 3 || studentId.length > 10) {
                showMessage('Student ID must be between 3 and 10 characters.', 'error');
                return;
            }
            if (grade < 0 || grade > 100) {
                showMessage('Grade must be between 0 and 100.', 'error');
                return;
            }

            const registeredUsers = getUsers();
            const isStudentRegistered = registeredUsers.some(u => u.id === studentId && u.role === 'student');
            if (!isStudentRegistered) {
                showMessage('Student ID not registered as a student. Please register the student first.', 'error');
                return;
            }

            let grades = getGradesRecords();
            const existingIndex = grades.findIndex(record =>
                record.studentId === studentId && record.subject.toLowerCase() === subject.toLowerCase()
            );

            if (existingIndex > -1) {
                grades[existingIndex].grade = grade;
                showMessage(`Grade for ${studentId} in ${subject} updated to ${grade}.`, 'success');
            } else {
                grades.push({ studentId, subject, grade });
                showMessage(`Grade ${grade} submitted for ${studentId} in ${subject}.`, 'success');
            }

            saveGradesRecords(grades);
            displayAllGrades();
            gradeStudentIdInput.value = '';
            subjectInput.value = '';
            gradeInput.value = '';
        }

        /**
         * Displays all grade records (Teacher view).
         */
        function displayAllGrades() {
            const grades = getGradesRecords();
            const users = getUsers(); // Get all users to map student IDs to names
            allGradesTableBody.innerHTML = '';

            if (grades.length === 0) {
                allGradesTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No grades recorded yet.</td></tr>`;
                return;
            }

            grades.sort((a, b) => {
                if (a.studentId < b.studentId) return -1;
                if (a.studentId > b.studentId) return 1;
                if (a.subject.toLowerCase() < b.subject.toLowerCase()) return -1;
                if (a.subject.toLowerCase() > b.subject.toLowerCase()) return 1;
                return 0;
            });

            grades.forEach((record, index) => {
                const row = allGradesTableBody.insertRow();
                row.className = 'border-b border-gray-200 hover:bg-gray-100';

                const studentName = users.find(u => u.id === record.studentId && u.role === 'student')?.name || 'N/A';

                row.insertCell().outerHTML = `<td class="py-3 px-6 text-left whitespace-nowrap">${record.studentId}</td>`;
                row.insertCell().outerHTML = `<td class="py-3 px-6 text-left whitespace-nowrap">${studentName}</td>`;
                row.insertCell().outerHTML = `<td class="py-3 px-6 text-left">${record.subject}</td>`;
                row.insertCell().outerHTML = `<td class="py-3 px-6 text-left">${record.grade}</td>`;

                const actionsCell = row.insertCell();
                actionsCell.className = 'py-3 px-6 text-center';
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'bg-red-500 text-white text-xs py-1 px-3 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400';
                deleteButton.onclick = () => deleteGrade(index);
                actionsCell.appendChild(deleteButton);
            });
        }

        /**
         * Displays grades for the logged-in student (Student view).
         * @param {string} studentId - The ID of the logged-in student.
         */
        function displayMyGrades(studentId) {
            studentGradesTableBody.innerHTML = '';
            const allGrades = getGradesRecords();
            const myGrades = allGrades.filter(record => record.studentId === studentId);

            if (myGrades.length === 0) {
                studentGradesTableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">No grades recorded for you yet.</td></tr>`;
                return;
            }

            myGrades.forEach(record => {
                const row = studentGradesTableBody.insertRow();
                row.className = 'border-b border-gray-200 hover:bg-gray-100';

                row.insertCell().outerHTML = `<td class="py-3 px-6 text-left">${record.subject}</td>`;
                row.insertCell().outerHTML = `<td class="py-3 px-6 text-left font-semibold">${record.grade}</td>`;

                const remarksCell = row.insertCell();
                remarksCell.className = 'py-3 px-6 text-left italic';
                if (record.grade >= 90) {
                    remarksCell.textContent = 'Excellent!';
                    remarksCell.classList.add('text-green-600');
                } else if (record.grade >= 80) {
                    remarksCell.textContent = 'Very Good!';
                    remarksCell.classList.add('text-blue-600');
                } else if (record.grade >= 75) {
                    remarksCell.textContent = 'Good.';
                    remarksCell.classList.add('text-purple-600');
                } else if (record.grade >= 70) {
                    remarksCell.textContent = 'Satisfactory.';
                    remarksCell.classList.add('text-orange-600');
                } else {
                    remarksCell.textContent = 'Needs Improvement.';
                    remarksCell.classList.add('text-red-600');
                }
            });
        }

        /**
         * Deletes a specific grade record (Teacher function).
         * @param {number} index - The index of the record to delete.
         */
        async function deleteGrade(index) {
            const confirmed = await confirmAction('Are you sure you want to delete this grade record?', 'DELETE');
            if (confirmed) {
                let grades = getGradesRecords();
                if (index >= 0 && index < grades.length) {
                    grades.splice(index, 1);
                    saveGradesRecords(grades);
                    displayAllGrades();
                    showMessage('Grade record deleted.', 'success');
                } else {
                    showMessage('Error: Record not found for deletion.', 'error');
                }
            } else {
                showMessage('Deletion cancelled.', 'info');
            }
        }

        /**
         * Clears all grade records (Teacher function).
         */
        async function clearAllGrades() {
            const confirmed = await confirmAction('This will clear ALL grade records. Are you sure?', 'CLEAR');
            if (confirmed) {
                localStorage.removeItem(GRADES_STORAGE_KEY);
                displayAllGrades();
                showMessage('All grade records have been cleared.', 'success');
            }
        }


        // --- Attendance Management ---
        /**
         * Retrieves attendance records.
         * @returns {Array<Object>} An array of attendance objects ({ studentId, date, status }).
         */
        function getAttendanceRecords() {
            const recordsJson = localStorage.getItem(ATTENDANCE_STORAGE_KEY);
            return recordsJson ? JSON.parse(recordsJson) : [];
        }

        /**
         * Saves attendance records.
         * @param {Array<Object>} records - The array of attendance objects to save.
         */
        function saveAttendanceRecords(records) {
            localStorage.setItem(ATTENDANCE_STORAGE_KEY, JSON.stringify(records));
        }

        /**
         * Marks attendance for a student (Teacher function).
         */
        async function markAttendance() {
            const studentId = attendanceStudentIdInput.value.trim().toUpperCase();
            const date = attendanceDateInput.value;
            const status = document.querySelector('input[name="attendanceStatus"]:checked').value;

            if (!studentId || !date || !status) {
                showMessage('Please fill in all attendance fields.', 'error');
                return;
            }
            if (studentId.length < 3 || studentId.length > 10) {
                showMessage('Student ID must be between 3 and 10 characters.', 'error');
                return;
            }

            const registeredUsers = getUsers();
            const isStudentRegistered = registeredUsers.some(u => u.id === studentId && u.role === 'student');
            if (!isStudentRegistered) {
                showMessage('Student ID not registered as a student. Please register the student first.', 'error');
                return;
            }

            let records = getAttendanceRecords();
            const existingIndex = records.findIndex(record =>
                record.studentId === studentId && record.date === date
            );

            if (existingIndex > -1) {
                records[existingIndex].status = status;
                showMessage(`Attendance for ${studentId} on ${date} updated to ${status}.`, 'success');
            } else {
                records.push({ studentId, date, status });
                showMessage(`Attendance marked for ${studentId} as ${status} on ${date}.`, 'success');
            }

            saveAttendanceRecords(records);
            displayAllAttendance();
            attendanceStudentIdInput.value = '';
        }

        /**
         * Displays all attendance records (Teacher view).
         */
        function displayAllAttendance() {
            const records = getAttendanceRecords();
            const users = getUsers(); // Get all users to map student IDs to names
            allAttendanceTableBody.innerHTML = '';

            if (records.length === 0) {
                allAttendanceTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No attendance records found.</td></tr>`;
                return;
            }

            records.sort((a, b) => {
                if (a.studentId < b.studentId) return -1;
                if (a.studentId > b.studentId) return 1;
                if (a.date < b.date) return -1;
                if (a.date > b.date) return 1;
                return 0;
            });

            records.forEach((record, index) => {
                const row = allAttendanceTableBody.insertRow();
                row.className = 'border-b border-gray-200 hover:bg-gray-100';

                const studentName = users.find(u => u.id === record.studentId && u.role === 'student')?.name || 'N/A';

                row.insertCell().outerHTML = `<td class="py-3 px-6 text-left whitespace-nowrap">${record.studentId}</td>`;
                row.insertCell().outerHTML = `<td class="py-3 px-6 text-left whitespace-nowrap">${studentName}</td>`;
                row.insertCell().outerHTML = `<td class="py-3 px-6 text-left">${record.date}</td>`;
                row.insertCell().outerHTML = `<td class="py-3 px-6 text-left">${record.status}</td>`;

                const actionsCell = row.insertCell();
                actionsCell.className = 'py-3 px-6 text-center';
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'bg-red-500 text-white text-xs py-1 px-3 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400';
                deleteButton.onclick = () => deleteAttendance(index);
                actionsCell.appendChild(deleteButton);
            });
        }

        /**
         * Displays attendance for the logged-in student (Student view).
         * @param {string} studentId - The ID of the logged-in student.
         */
        function displayMyAttendance(studentId) {
            studentAttendanceTableBody.innerHTML = '';
            const allRecords = getAttendanceRecords();
            const myRecords = allRecords.filter(record => record.studentId === studentId);

            if (myRecords.length === 0) {
                studentAttendanceTableBody.innerHTML = `<tr><td colspan="2" class="text-center py-4 text-gray-500">No attendance records for you yet.</td></tr>`;
                return;
            }

            myRecords.forEach(record => {
                const row = studentAttendanceTableBody.insertRow();
                row.className = 'border-b border-gray-200 hover:bg-gray-100';

                row.insertCell().outerHTML = `<td class="py-3 px-6 text-left">${record.date}</td>`;
                row.insertCell().outerHTML = `<td class="py-3 px-6 text-left font-semibold">${record.status}</td>`;
            });
        }

        /**
         * Deletes a specific attendance record (Teacher function).
         * @param {number} index - The index of the record to delete.
         */
        async function deleteAttendance(index) {
            const confirmed = await confirmAction('Are you sure you want to delete this attendance record?', 'DELETE');
            if (confirmed) {
                let records = getAttendanceRecords();
                if (index >= 0 && index < records.length) {
                    records.splice(index, 1);
                    saveAttendanceRecords(records);
                    displayAllAttendance();
                    showMessage('Attendance record deleted.', 'success');
                } else {
                    showMessage('Error: Record not found for deletion.', 'error');
                }
            } else {
                showMessage('Deletion cancelled.', 'info');
            }
        }

        /**
         * Clears all attendance records (Teacher function).
         */
        async function clearAllAttendance() {
            const confirmed = await confirmAction('This will clear ALL attendance records. Are you sure?', 'CLEAR');
            if (confirmed) {
                localStorage.removeItem(ATTENDANCE_STORAGE_KEY);
                displayAllAttendance();
                showMessage('All attendance records have been cleared.', 'success');
            }
        }
    </script>
</body>
</html>
